<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status de Contribuição - Questões CFC</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f0f2f5; 
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px; 
            margin: 0 auto;
        }
        header {
            background-color: #004a91;
            color: #ffffff;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        header h1 { 
            margin: 0; 
            font-size: 1.8em;
        }
        
        main {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* (AJUSTADO) Espaço extra pro fim da página */
        }

        /* --- Estilos da Barra de Progresso --- */
        #progress-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        #progress-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #004a91;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
        }
        #progress-label .percentage {
            font-size: 1.2em;
        }
        .progress-bar-background {
            width: 100%;
            height: 24px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        #progress-bar-fill {
            height: 100%;
            width: 0%; 
            background-color: #28a745;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            transition: width 0.6s ease;
        }
        #progress-sublabel {
            text-align: right; 
            font-size: 0.9em; 
            margin-top: 5px; 
            color: #555;
        }
        
        #loading-message {
            text-align: center;
            font-size: 1.2em;
            color: #004a91;
            padding: 30px;
        }

        #status-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #status-table th, 
        #status-table td {
            border: 1px solid #ddd;
            padding: 10px 12px; 
            text-align: left;
            font-size: 0.95em; 
        }
        
        /* (AJUSTADO) Coluna do "Nº da Questão" agora só centraliza */
        #status-table th:nth-child(3),
        #status-table td:nth-child(3) {
            text-align: center;
            /* width: 1% foi REMOVIDO para deixar automático */
        }
        
        #status-table th {
            background-color: #f0f2f5;
            color: #004a91;
        }
        #status-table th[data-sort] {
            cursor: pointer;
            user-select: none;
        }
        #status-table th[data-sort]::after {
            content: ' \25B2\25BC'; 
            color: #ccc;
            font-size: 0.8em;
        }
        #status-table th[data-sort].sort-asc::after {
            content: ' \25B2'; 
            color: #004a91;
        }
        #status-table th[data-sort].sort-desc::after {
            content: ' \25BC'; 
            color: #004a91;
        }

        .status-sim {
            color: #218838;
            font-weight: 600;
        }
        .status-nao {
            color: #d9534f;
            font-weight: 600;
        }
        
        /* (NOVO) Botão Voltar ao Topo (do index.html) */
        #btn-back-to-top {
            display: none; position: fixed; bottom: 20px; right: 30px; z-index: 99;
            font-size: 18px; border: none; outline: none; background-color: #004a91;
            color: white; cursor: pointer; padding: 12px 16px; border-radius: 5px;
            transition: background-color 0.2s; line-height: 1;
        }
        #btn-back-to-top:hover { background-color: #003366; }


        @media (max-width: 700px) {
            body {
                padding: 10px; 
            }
            .container {
                padding: 0; 
            }
            main {
                padding: 15px; 
            }
            header h1 {
                font-size: 1.5em; 
            }
            #progress-label {
                font-size: 1em; 
            }
            #progress-sublabel {
                font-size: 0.85em;
            }
            
            #status-table th, 
            #status-table td {
                padding: 8px 6px; 
                font-size: 0.85em; 
            }
        }
        
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Status de Contribuição das Questões</h1>
        </header>

        <main> 
            <section id="progress-section">
                <div id="progress-label">
                    <span>Questões Disponíveis:</span>
                    <span id="progress-percentage" class="percentage">Calculando...</span>
                </div>
                <div class="progress-bar-background">
                    <div id="progress-bar-fill"></div>
                </div>
                <div id="progress-sublabel">
                    Calculando...
                </div>
            </section>

            <div id="loading-message">
                <p>Carregando e processando arquivos JSON...</p>
            </div>

            <table id="status-table" style="display: none;">
                <thead>
                    <tr>
                        <th data-sort="disponivel">Disponível?</th>
                        <th data-sort="edicao">Edição do Exame</th>
                        
                        <th>Nº da Questão</th> 
                        
                        <th data-sort="resolucao">Resolução Comentada?</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </main>
        
        </div> <button id="btn-back-to-top" title="Voltar ao topo">&#8593;</button>

    <script>
        // --- 1. CONFIGURAÇÃO ---
        
        const configDisciplinas = {
            "Contabilidade Societária": {
                arquivo: 'contabilidade-societaria.json'
            }
            /*
            // Exemplo de como adicionar mais:
            ,
            "Contabilidade de Custos": {
                arquivo: 'db_custos.json'
            },
            "Auditoria": {
                arquivo: 'db_auditoria.json'
            }
            */
        };

        const QUESTIONS_PER_EXAM = 50;

        let masterTableData = []; 
        let questionMap = new Map(); 
        let sortState = {
            column: 'edicao',  
            direction: 'asc' 
        };

        // --- 2. LÓGICA PRINCIPAL ---
        
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingMsg = document.getElementById('loading-message');
            const table = document.getElementById('status-table');

            try {
                // Passo 1: Carregar dados
                await loadAllData();

                // Passo 2: Gerar lista de exames
                const canonicalExams = generateCanonicalExamsList();
                
                // Passo 3: Criar dados da tabela
                masterTableData = buildMasterTableData(canonicalExams);

                // Lógica para atualizar a Barra de Progresso
                const totalQuestoesMestra = masterTableData.length; // O 100%
                const totalDisponiveis = questionMap.size; // O atual
                const porcentagem = (totalDisponiveis / totalQuestoesMestra) * 100;
                
                const progressLabel = document.getElementById('progress-percentage');
                const progressSubLabel = document.getElementById('progress-sublabel');
                const progressBarFill = document.getElementById('progress-bar-fill');
                
                progressLabel.textContent = `${porcentagem.toFixed(1)}%`;
                progressSubLabel.textContent = `${totalDisponiveis} de ${totalQuestoesMestra} questões cadastradas`;
                
                setTimeout(() => {
                    progressBarFill.style.width = `${porcentagem}%`;
                }, 100);

                // Passo 4: Fazer o sort e render INICIAL
                document.querySelector(`th[data-sort="${sortState.column}"]`).classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                sortData(masterTableData, sortState.column, sortState.direction);
                renderTable(masterTableData);
                
                // Passo 5: Configurar os cliques
                setupSorting(); 

                // Esconde o loading e mostra a tabela
                loadingMsg.style.display = 'none';
                table.style.display = 'table';
                
            } catch (error) {
                loadingMsg.innerHTML = `<p style="color: red;">Erro ao carregar dados: ${error.message}</p>`;
                console.error("Falha no processo:", error);
            }
            
            // --- (NOVO) Lógica do Botão Voltar ao Topo ---
            const btnBackToTop = document.getElementById('btn-back-to-top');
            
            window.onscroll = () => {
                if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                    btnBackToTop.style.display = "block";
                } else {
                    btnBackToTop.style.display = "none";
                }
            };
            
            btnBackToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            // --- Fim da Lógica do Botão ---
            
        });

        /**
         * Passo 1: Carrega todos os JSONs da 'configDisciplinas' 
         * e armazena em um Map global para consulta rápida.
         */
        async function loadAllData() {
            const promessas = Object.values(configDisciplinas).map(async (config) => {
                try {
                    const response = await fetch(config.arquivo);
                    if (!response.ok) {
                        throw new Error(`Falha ao carregar ${config.arquivo}: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return []; // Retorna array vazio em caso de falha
                }
            });

            const todosOsArraysDeQuestoes = await Promise.all(promessas);
            
            // Limpa o map e preenche com todas as questões de todos os arquivos
            questionMap.clear();
            todosOsArraysDeQuestoes.forEach(disciplina => {
                disciplina.forEach(questao => {
                    const uniqueID = `${questao.exame}-${questao.id}`;
                    questionMap.set(uniqueID, questao);
                });
            });

            console.log(`Map de questões preenchido com ${questionMap.size} questões únicas.`);
        }

        /**
         * Passo 2: Gera a lista "mestra" de todos os exames desde 2011.
         */
        function generateCanonicalExamsList() {
            const exams = [];
            const currentYear = new Date().getFullYear(); // Pega o ano atual (2025)

            for (let y = 2011; y <= currentYear; y++) {
                if (y === 2012) {
                    exams.push("CFC 2012/1"); 
                } else if (y === 2024) {
                    exams.push("CFC 2024/1");
                    exams.push("CFC 2024/2");
                    exams.push("CFC 2024/1 RS");
                } else {
                    exams.push(`CFC ${y}/1`);
                    exams.push(`CFC ${y}/2`);
                }
            }
            return exams;
        }

        /**
         * Passo 3: Cria o array de dados para a tabela.
         */
        function buildMasterTableData(canonicalExams) {
            const tableData = [];
            
            canonicalExams.forEach(exame => {
                for (let i = 1; i <= QUESTIONS_PER_EXAM; i++) {
                    const uniqueID = `${exame}-${i}`;
                    const question = questionMap.get(uniqueID);
                    
                    const hasResolucao = question && question.resolucao && question.resolucao.trim() !== "";
                    
                    tableData.push({
                        id: uniqueID,
                        disponivel: question ? 'Sim' : 'Não',
                        edicao: exame,
                        numero: i,
                        resolucao: hasResolucao ? 'Sim' : 'Não'
                    });
                }
            });
            
            return tableData;
        }

        /**
         * Passo 4: Renderiza o HTML da tabela.
         */
        function renderTable(data) {
            const tableBody = document.getElementById('table-body');
            let html = '';
            
            data.forEach(row => {
                const dispClass = row.disponivel === 'Sim' ? 'status-sim' : 'status-nao';
                const resClass = row.resolucao === 'Sim' ? 'status-sim' : 'status-nao';
                
                html += `
                    <tr>
                        <td class="${dispClass}">${row.disponivel}</td>
                        <td>${row.edicao}</td>
                        <td>${row.numero}</td>
                        <td class="${resClass}">${row.resolucao}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        /**
         * Passo 5: Configura a ordenação da tabela (SÓ OS CLIQUES).
         */
        function setupSorting() {
            const headers = document.querySelectorAll('#status-table th[data-sort]');
            
            headers.forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-sort');
                    
                    if (sortState.column === column) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = column;
                        sortState.direction = 'asc';
                    }
                    
                    sortData(masterTableData, sortState.column, sortState.direction);
                    renderTable(masterTableData);
                    
                    headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                    th.classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                });
            });
        }

        // --- 3. LÓGICA DE ORDENAÇÃO (COM 3 NÍVEIS) ---

        /**
         * (FUNÇÃO AJUDANTE)
         * Compara duas strings de edição de exame
         */
        function compareEditions(edicaoA, edicaoB) {
            const matchA = edicaoA.match(/(\d{4})\/(.*)/);
            const matchB = edicaoB.match(/(\d{4})\/(.*)/);
            
            if (!matchA || !matchB) {
                 return edicaoA.localeCompare(edicaoB);
            }
            
            const anoA = parseInt(matchA[1]);
            const anoB = parseInt(matchB[1]);
            
            if (anoA !== anoB) {
                return anoA - anoB;
            }
            
            return edicaoA.localeCompare(edicaoB);
        }
        
        /**
         * Função auxiliar para ordenar o array de dados.
         * (VERSÃO ATUALIZADA COM 3 NÍVEIS DE DESEMPATE)
         */
        function sortData(data, column, direction) {
            const dirMod = direction === 'asc' ? 1 : -1;
            
            data.sort((a, b) => {
                
                // --- 1. Calcular Resultado Primário (sem direção) ---
                let primaryResult = 0;
                if (column === 'edicao') {
                    primaryResult = compareEditions(a.edicao, b.edicao);
                } else {
                    primaryResult = a[column].localeCompare(b[column]);
                }
                
                if (primaryResult !== 0) {
                    return primaryResult * dirMod;
                }
                
                // --- 2. Calcular Resultado Secundário (sem direção) ---
                let secondaryResult = 0;
                if (column === 'edicao') {
                    secondaryResult = a.numero - b.numero;
                } else {
                    secondaryResult = compareEditions(a.edicao, b.edicao);
                }

                if (secondaryResult !== 0) {
                     return secondaryResult * dirMod;
                }

                // --- 3. Calcular Resultado Terciário (sem direção) ---
                let tertiaryResult = a.numero - b.numero;
                
                return tertiaryResult * dirMod;
            });
        }

    </script>
</body>
</html>